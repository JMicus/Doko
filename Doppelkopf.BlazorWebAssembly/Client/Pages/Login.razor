@page "/login"

@using Doppelkopf.BlazorWebAssembly.Client.Helper
@using Doppelkopf.BlazorWebAssembly.Client.Enums
@using Doppelkopf.BlazorWebAssembly.Client.Services

@inject NavigationManager NavManager
@inject StateService StateService
@inject MenuService MenuService
@inject Doppelkopf.Core.Connection.Client Client
@inject IJSRuntime JSRuntime

<div style="display: flex;align-items: center; justify-content: center; height: 100%; width: 100%">

    <RadzenCard Style="width: fit-content">
        <div class="row">
            <div class="col-xl-6">
                <p class="input">Spiel</p>
                <RadzenTextBox @bind-value=@gameName Name="GameName" Style=@inputStyle />
                <RadzenRequiredValidator Component="GameName" Text="Spiel angeben!" Popup=@popup Style="position: absolute" />

                <p class="input">Dein Name</p>
                <RadzenTextBox @bind-value=@playerName Style=@inputStyle />

                <p class="input">Spieler*innennummer</p>
                <RadzenDropDown @bind-Value=@playerNo AllowClear="false" TValue="string"
                                Data=@playerNoOptions
                                Style=@inputStyle />

                <p class="input"></p>
                <RadzenButton Click=@(args => OnClickLogin()) Text="Login" Style="margin-left: 60px; width: 120px" />
            </div>
        </div>
    </RadzenCard>
</div>


@code {

    private string inputStyle = "margin-bottom: 20px; width: 250px";

    private List<string> playerNoOptions = new List<string>() { "Auto", "1", "2", "3", "4" };

    private string gameName;
    private string playerName;
    private string playerNo;

    private bool popup;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        MenuService.OpenTab.Value = EMenuAction.PageLogin;

        StateService.Clear();
        StateService.Init(Client, NavManager, JSRuntime);

        gameName = StateService.GameName;
        playerName = StateService.PlayerName;
        playerNo = StateService.PlayerNo > 0 ? StateService.PlayerNo.Value.ToString() : "Auto";
    }

    void OnClickLogin()
    {
        //Client.Init(NavManager.ToAbsoluteUri("/dokohub"), gameName, int.Parse(playerNo.Length > 1 ? "0" : playerNo));

        MenuService.OpenTab.Value = EMenuAction.PageTable;

        if (StateService.Init(Client, NavManager, JSRuntime))
        {

        }

        Client.OnInitialized += OnInitialized;

        var playerNoInt = 0;
        int.TryParse(playerNo, out playerNoInt);


        Console.WriteLine("init " + playerNo + " " + playerName);

        StateService.PlayerName.Value = playerName;
        Client.Init(gameName, playerNoInt, playerName, null);
    }

    void OnInitialized(string gameName, int playerNo, string playerToken)
    {
        //StateService.Init(Client, NavManager, JSRuntime);

        StateService.GameName.Value = gameName;
        StateService.PlayerNo.Value = playerNo;
        StateService.Token.Value = playerToken;

        NavManager.NavigateTo(StateService.CreateUrl("game"));
    }

}
